; Rois Archive External Parser V1.0
; Usage: Include in your Blitz3D Applications to utilize Rois 
; Archives, eg. Portable executables, non directly shown files 
; (great for secrets btw).
; Encryption soon :D

Global roisArcOutputFileHandle = 0
Global roisArcFileHandle = 0
Global argRoisArch1$ = ""
Global argRoisArch2 = 0
Global cmdRoisArch$ = ""
Global argsRoisArch$ = ""
Global spacePosRoisArch = 0

remoteStorageParentDirectory$ = CurrentDir$()
remoteStorageDirectoryName$ = "RemoteApplStorage_" + Str(MilliSecs())
CreateDir remoteStorageDirectoryName$
ChangeDir remoteStorageParentDirectory$

; Returns a ReadFile handle, but make sure you are in the 
; directory where the RemoteApplStorage directory was created.
; Use the global, remoteStorageParentDirectory, I created if 
; you want to.
; Also, make sure to use CloseFile() before finalizing/ending.
Function readRoisArcFile(roisArcHandle, fileName$)
	While Not Eof(roisArchHandle)
		roisArcFileHandle = 0
		argRoisArch1$ = ""
		argRoisArch2 = 0
		cmdRoisArch$ = ""
		argsRoisArch$ = ""
		spacePosRoisArch = 0
		Line$ = Trim(ReadLine$(arcFile))
		
		; Skip empty lines using label
		If Line$ = "" Then RuntimeError("External Parser is unable to parse blank lines.")
		; Parse command and arguments
		spacePosRoisArch = Instr(Line$ + " ", " ")
		If spacePosRoisArch <= 1 Then RuntimeError("Malformed: " + FilePos(arcFile))
		cmdRoisArch$ = Upper$(Left$(Line$, spacePosRoisArch - 1))
		argsRoisArch$ = Mid$(Line$, spacePosRoisArch + 1)
		
		spacePosRoisArch = 0
		
		Select cmdRoisArch$
				
			Case "." ; Create files
				spacePosRoisArch = Instr(argsRoisArch$ + " ", " ")
				If spacePosRoisArch <= 1 Then RuntimeError("Malformed: " + FilePos(arcFile))
				argRoisArch1$ = Left$(argsRoisArch$, spacePosRoisArch - 1)
				If Not argRoisArch1$ Then RuntimeError("Filename not given.")
				If argRoisArch1$ = fileName$ Then 
					argRoisArch2= Int(Mid$(argsRoisArch$, spacePosRoisArch + 1))
					file = WriteFile(remoteStorageDirectoryName$ + "\" + argRoisArch1$)
					If argRoisArch2 Then 
						For i=1 To argRoisArch2
							WriteLine(file, ReadLine(arcFile))
						Next
					Else
					EndIf
					CloseFile(file)
					roisArcOutputFileHandle = ReadFile(argRoisArch1$)
					Return roisArcOutputFileHandle
				EndIf
			
			Case "!"
				
			
			Case ";"
				
			
			Case ":"
				
						
			Case "?"
				
			
			Default
					RuntimeError("Not a valid v1.0 Rois Archive!")
				
		End Select
	Wend
End Function

; Always do this when finished otherwise it may be taking up storage!
Function finalizeRoisRemoteStorage()
	ChangeDir remoteStorageParentDirectory$
	DeleteDir remoteStorageDirectoryName$
End Function
